# **NOTE**: this file is generated by `dhall-render`.
# You should NOT edit it manually, your changes will be lost.

---
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: '1'
    - env:
        DOCKER_PASSWORD: "${{ secrets.GITHUB_TOKEN }}"
      name: Login to docker.pkg.github.com
      run: |-
        set -eu -o pipefail
        set -x
        docker login -u "$GITHUB_ACTOR" --password-stdin docker.pkg.github.com <<EOF
        $DOCKER_PASSWORD
        EOF
    - env:
        BRANCH_REF: "${{ github.head_ref || github.ref }}"
      name: Docker build
      run: |-
        set -eu -o pipefail
        set -x
        docker pull "docker.pkg.github.com/timbertson/foperator/foperator:latest" || true
        docker pull "docker.pkg.github.com/timbertson/foperator/foperator:$(echo "${BRANCH_REF#refs/heads/}" | tr / -)" || true
        docker "build" "--progress=plain" "--file=Dockerfile" "--cache-from=docker.pkg.github.com/timbertson/foperator/foperator:latest" "--cache-from=docker.pkg.github.com/timbertson/foperator/foperator:$(echo "${BRANCH_REF#refs/heads/}" | tr / -)" "--tag=docker.pkg.github.com/timbertson/foperator/foperator:$GITHUB_SHA" "--tag=docker.pkg.github.com/timbertson/foperator/foperator:$(echo "${BRANCH_REF#refs/heads/}" | tr / -)" "."
        docker push "docker.pkg.github.com/timbertson/foperator/foperator:$GITHUB_SHA"
        docker push "docker.pkg.github.com/timbertson/foperator/foperator:$(echo "${BRANCH_REF#refs/heads/}" | tr / -)"
    - if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref
        == 'refs/heads/master')
      name: Docker push :latest
      run: |-
        set -eu -o pipefail
        set -x
        docker tag "docker.pkg.github.com/timbertson/foperator/foperator:$GITHUB_SHA" "docker.pkg.github.com/timbertson/foperator/foperator:latest"
        docker push "docker.pkg.github.com/timbertson/foperator/foperator:latest"
    - name: Test
      run: |-
        set -eu -o pipefail
        set -x
        docker run --rm -i "docker.pkg.github.com/timbertson/foperator/foperator:$GITHUB_SHA" bash -eu -o pipefail <<EOF_runInDocker
          sbt 'strict compile' test

        EOF_runInDocker
    - name: Dhall cache
      uses: actions/cache@v1
      with:
        key: dhall-cache-${{ hashFiles('dhall/dependencies/*') }}
        path: "~/.cache/dhall"
    - name: Check generated files
      run: "set -eu -o pipefail\nset -x\ndocker run --rm -i \"--volume\" \"$HOME/.cache:/root/.cache\"
        \"--volume\" \"$PWD:/cwd\" \"--workdir=/cwd\" \"docker.pkg.github.com/timbertson/dhall-ci/dhall:1.40\"
        bash -eu -o pipefail <<EOF_runInDocker\n  ./dhall/render\n  ./dhall/fix --lint
        dhall\n  if ! git --no-pager diff --patch --exit-code HEAD -- >&2; then\n
        \   set +x\n    echo >&2\n    echo '--------------------------------' >&2\n
        \   echo 'Uncommitted changes found, please run the following locally and
        commit the changes:' >&2\n    cat >&2 <<EOF_diff\n      ./dhall/render\n  ./dhall/fix
        --lint dhall\n    \nEOF_diff\n    exit 1\n  fi\n\nEOF_runInDocker"
name: CI
'on':
  pull_request: {}
  push:
    branches:
    - master
    - main
